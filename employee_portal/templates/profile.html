{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Announcements logic -->
    {% if announcements and current_user.role not in ['admin', 'director'] %}
    <div class="row mb-4">
        <div class="col-12">
            <div id="announcement-section" class="card border-0 shadow-sm rounded-4 wow-orange overflow-hidden" style="color: #e67e22 !important;">
                <div class="card-body p-4 d-flex align-items-center">
                    <div class="me-4 display-6"><i class="bi bi-megaphone-fill"></i></div>
                    <div>
                        <h5 class="fw-bold mb-1">Company Announcement</h5>
                        {% for ann in announcements %}
                        <div class="small opacity-90" style="color: #e67e22 !important;">{{ ann.title }}: {{ ann.content }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Welcome Banner & Search - Elegant Orange Style -->
    <div class="card elegant-orange-header border-0 mb-4">
        <div class="card-body py-4 px-4 d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <div class="greeting-text text-white">
                    <h4 class="fw-bold mb-1 d-inline"><span id="time-greeting-profile">Welcome</span></h4>, <span>{{ current_user.profile.first_name if current_user.profile else current_user.employeeid }}</span>!
                </div>
            </div>
            
            <div class="position-relative" style="min-width: 300px;">
                <form action="{{ url_for('main.directory') }}" method="GET">
                    <div class="input-group shadow-sm rounded-pill overflow-hidden">
                        <span class="input-group-text bg-white border-0"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" name="search_query" id="directorySearch" class="form-control border-0 bg-white shadow-none" placeholder="Search colleagues..." list="directory-suggestions" autocomplete="off">
                        <datalist id="directory-suggestions"></datalist>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Header Widget - Profile Card -->
    <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden" style="border: 1px solid #e2e8f0 !important;">
        <div class="card-header bg-white py-3 border-0 rounded-top-4" style="border-left: 4px solid #e67e22 !important;">
            <h6 class="m-0 fw-semibold text-dark"><i class="bi bi-person-vcard me-2 text-primary"></i>Profile Card</h6>
        </div>
        <div class="card-body p-0">
            <div class="row g-0">
                <div class="col-md-4 bg-light p-4 d-flex flex-column align-items-center justify-content-center text-center border-end">
                    <div class="position-relative d-inline-block mb-3">
                        <img src="{{ image_file }}" alt="avatar" class="rounded-circle border border-4 border-white shadow-sm" style="width: 120px; height: 120px; object-fit: cover;">
                        
                        {% if current_user.profile %}
                        <label for="profile_pic_upload" class="position-absolute bottom-0 end-0 bg-white text-primary rounded-circle shadow-sm p-2 border border-light" style="cursor: pointer; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Change Picture">
                            <i class="bi bi-camera-fill fs-6"></i>
                        </label>
                        <form action="{{ url_for('main.upload_image') }}" method="POST" enctype="multipart/form-data" id="profilePicForm" class="d-none">
                            <input type="file" name="image" id="profile_pic_upload" accept="image/*" onchange="document.getElementById('profilePicForm').submit();">
                        </form>
                        {% endif %}
                    </div>
                    <h5 class="fw-bold mb-1 text-dark">
                        {% if current_user.profile %}
                            {{ current_user.profile.first_name }} {{ current_user.profile.last_name }}
                        {% else %}
                            {{ current_user.role|capitalize }}
                        {% endif %}
                    </h5>
                    <p class="mb-0 text-muted extra-small fw-semibold text-uppercase">
                        {% if current_user.profile and current_user.profile.designation %}
                            {{ current_user.profile.designation.title }}
                        {% else %}
                            User
                        {% endif %}
                    </p>
                    <small class="text-muted extra-small">{{ current_user.email }}</small>
                </div>
                <div class="col-md-8 p-4 bg-white">
                    <h6 class="text-secondary text-uppercase extra-small fw-bold mb-3">Quick Overview</h6>
                    <div class="row g-3">
                        <div class="col-6 col-sm-4">
                            <div class="p-3 border rounded-4 bg-light text-center">
                                <i class="bi bi-calendar-check fs-4 text-primary mb-1"></i>
                                <div class="extra-small fw-bold text-muted text-uppercase">Joined</div>
                                <div class="fw-bold text-dark small">{{ current_user.profile.date_of_joining.strftime('%b %Y') if current_user.profile and current_user.profile.date_of_joining else 'N/A' }}</div>
                            </div>
                        </div>
                        <div class="col-6 col-sm-4">
                            <div class="p-3 border rounded-4 bg-light text-center">
                                <i class="bi bi-briefcase fs-4 text-success mb-1"></i>
                                <div class="extra-small fw-bold text-muted text-uppercase">Exp.</div>
                                <div class="fw-bold text-dark small">{{ current_user.profile.years_of_experience if current_user.profile else '0' }} Yrs</div>
                            </div>
                        </div>
                        <div class="col-6 col-sm-4">
                            <div class="p-3 border rounded-4 bg-light text-center">
                                <i class="bi bi-people fs-4 text-info mb-1"></i>
                                <div class="extra-small fw-bold text-muted text-uppercase">Manager</div>
                                <div class="fw-bold text-dark extra-small text-truncate px-1">{{ current_user.profile.reports_to if current_user.profile and current_user.profile.reports_to else '-' }}</div>
                            </div>
                        </div>
                    </div>

                    {% if current_user.role not in ['admin', 'director'] %}
                    <div id="attendanceButtonContainer" class="d-flex align-items-center justify-content-center mt-4">
                        <!-- Buttons will be loaded here by JavaScript -->
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs & Side Widgets -->
    {% if current_user.profile %}
    <div class="row">
        <!-- Left Side: Profile Details & History -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 mb-4" style="border: 1px solid #e2e8f0 !important;">
                <div class="card-header bg-white border-0 py-3 rounded-top-4" style="border-left: 4px solid #e67e22 !important;">
                    <ul class="nav nav-pills card-header-pills" id="profileTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active rounded-pill px-4 extra-small fw-bold text-uppercase" data-bs-toggle="tab" data-bs-target="#personal" type="button">Profile Details</button>
                        </li>
                        {% if current_user.role not in ['admin', 'director'] %}
                        <li class="nav-item">
                            <button class="nav-link rounded-pill px-4 extra-small fw-bold text-uppercase" data-bs-toggle="tab" data-bs-target="#leave" type="button">Leave History</button>
                        </li>
                        {% endif %}
                        
                        {% if current_user.role not in ['admin', 'director'] or assigned_tasks %}
                        <li class="nav-item">
                            <button class="nav-link rounded-pill px-4 extra-small fw-bold text-uppercase" data-bs-toggle="tab" data-bs-target="#tasks" type="button">My Tasks</button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="card-body p-4">
                    <div class="tab-content" id="profileTabsContent">
                        <!-- Profile Tab -->
                        <div class="tab-pane fade show active" id="personal" role="tabpanel">
                            <h6 class="text-primary text-uppercase extra-small fw-bold mb-3 border-bottom pb-2">Identification & Personal</h6>
                            <div class="row g-3 mb-4">
                                <div class="col-sm-6">
                                    <label class="text-muted extra-small fw-bold text-uppercase">Full Name</label>
                                    <div class="fw-medium text-dark">{{ current_user.profile.first_name }} {{ current_user.profile.last_name }}</div>
                                </div>
                                <div class="col-sm-6">
                                    <label class="text-muted extra-small fw-bold text-uppercase">Employee ID</label>
                                    <div class="fw-medium text-dark font-monospace small">{{ current_user.employeeid }}</div>
                                </div>
                                <div class="col-sm-6">
                                    <label class="text-muted extra-small fw-bold text-uppercase">Date of Birth</label>
                                    <div class="fw-medium text-dark">{{ current_user.profile.date_of_birth.strftime('%d %b %Y') if current_user.profile.date_of_birth else '-' }}</div>
                                </div>
                                <div class="col-sm-6">
                                    <label class="text-muted extra-small fw-bold text-uppercase">Phone</label>
                                    <div class="fw-medium text-dark">{{ current_user.profile.phone_number }}</div>
                                </div>
                                <div class="col-sm-6">
                                    <label class="text-muted extra-small fw-bold text-uppercase">UAN Number</label>
                                    <div class="fw-medium text-dark">{{ current_user.profile.uan_number or '-' }}</div>
                                </div>
                                <div class="col-sm-6">
                                    <label class="text-muted extra-small fw-bold text-uppercase">PF Number</label>
                                    <div class="fw-medium text-dark">{{ current_user.profile.pf_number or '-' }}</div>
                                </div>
                                <div class="col-sm-6">
                                    <label class="text-muted extra-small fw-bold text-uppercase">ESI Number</label>
                                    <div class="fw-medium text-dark">{{ current_user.profile.esi_number or '-' }}</div>
                                </div>
                                <div class="col-12">
                                    <label class="text-muted extra-small fw-bold text-uppercase">Residential Address</label>
                                    <div class="fw-medium text-dark small">{{ current_user.profile.address }}</div>
                                </div>
                            </div>
                            
                            <h6 class="text-primary text-uppercase extra-small fw-bold mb-3 border-bottom pb-2">Banking Information</h6>
                            <div class="row g-3">
                                <div class="col-sm-6">
                                    <label class="text-muted extra-small fw-bold text-uppercase">Bank Name</label>
                                    <div class="fw-medium text-dark">{{ current_user.profile.bank_name }}</div>
                                </div>
                                <div class="col-sm-6">
                                    <label class="text-muted extra-small fw-bold text-uppercase">Account Number</label>
                                    <div class="fw-medium text-dark font-monospace small">{{ current_user.profile.bank_account_number }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Leave Tab -->
                        {% if current_user.role not in ['admin', 'director'] %}
                        <div class="tab-pane fade" id="leave" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light text-muted extra-small text-uppercase">
                                        <tr>
                                            <th>Date Range</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for leave in current_user.profile.leaves %}
                                        <tr>
                                            <td class="small fw-medium">
                                                {{ leave.start_date.strftime('%d %b') }}
                                                {% if leave.start_date != leave.end_date %}
                                                - {{ leave.end_date.strftime('%d %b %Y') }}
                                                {% endif %}
                                            </td>
                                            <td class="extra-small text-muted">{{ leave.leave_type }}</td>
                                            <td>
                                                <span class="text-{% if leave.status == 'Approved' %}success{% elif leave.status == 'Pending' %}warning text-dark{% else %}danger{% endif %} fw-bold extra-small">
                                                    {{ leave.status }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr><td colspan="3" class="text-center py-4 text-muted small">No leave records.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {% endif %}

                        <!-- Tasks Tab -->
                        {% if current_user.role not in ['admin', 'director'] or assigned_tasks %}
                        <div class="tab-pane fade" id="tasks" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light text-muted extra-small text-uppercase">
                                        <tr>
                                            <th>Task Description</th>
                                            <th>Status</th>
                                            <th>Follow-up</th>
                                            <th class="text-end">Update</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for task in assigned_tasks %}
                                        <tr>
                                            <td class="small">
                                                <div class="fw-bold text-dark">{{ task.master_task.description }}</div>
                                                <div class="extra-small text-muted text-uppercase">{{ task.master_task.task_type }}</div>
                                            </td>
                                            <td>
                                                <span class="text-{% if task.status == 'Completed' %}success{% elif task.status == 'Rejected' %}danger{% elif task.status == 'WIP' %}info{% else %}secondary{% endif %} fw-bold extra-small">
                                                    {{ task.status }}
                                                </span>
                                            </td>
                                            <td class="small text-muted">
                                                {{ task.followup_date.strftime('%d %b') if task.followup_date else '-' }}
                                            </td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-light text-primary rounded-circle shadow-sm" onclick="window.location.href='{{ url_for('main.view_task_details', task_id=task.id) }}'">
                                                    <i class="bi bi-pencil-square"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr><td colspan="4" class="text-center py-4 text-muted small">No assigned tasks.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side: Independent Widgets -->
        <div class="col-lg-4">
            <!-- Attendance Widget -->
            {% if current_user.role not in ['admin', 'director'] %}
            <div class="card border-0 shadow-sm rounded-4 mb-4" style="border: 1px solid #e2e8f0 !important;">
                <div class="card-header bg-white py-3 border-0 rounded-top-4" style="border-left: 4px solid #e67e22 !important;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-semibold text-dark"><i class="bi bi-clock me-2 text-primary"></i>Attendance</h6>
                        {% if todays_attendance %}
                            <span class="badge bg-success bg-opacity-10 text-success rounded-pill extra-small px-2">Present</span>
                        {% else %}
                            <span class="badge bg-secondary bg-opacity-10 text-secondary rounded-pill extra-small px-2">Absent</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if todays_attendance %}
                        <div class="text-center py-2">
                            <h2 class="text-dark fw-bold mb-0">{{ todays_attendance.check_in.strftime('%H:%M') }}</h2>
                            <small class="text-muted extra-small text-uppercase fw-bold">Check In Time</small>
                        </div>
                    {% else %}
                        <div class="text-center py-2">
                            <p class="text-muted small mb-0">Not checked in today.</p>
                        </div>
                    {% endif %}
                    <hr class="my-3 opacity-10">
                    <small class="text-muted text-uppercase fw-bold extra-small mb-2 d-block">Recent Activity</small>
                    <ul class="list-unstyled mb-0">
                        {% for att in attendance_records[:3] %}
                        <li class="mb-2 d-flex justify-content-between align-items-center extra-small">
                            <span class="fw-semibold text-secondary">{{ att.check_in.strftime('%d %b') }}</span>
                            <span class="text-dark font-monospace">{{ att.check_in.strftime('%H:%M') }} - {{ att.check_out.strftime('%H:%M') if att.check_out else '...' }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Action Items Widget -->
            {% if assigned_tasks %}
            <div class="card border-0 shadow-sm rounded-4 mb-4" style="border: 1px solid #e2e8f0 !important;">
                <div class="card-header bg-white py-3 border-0 rounded-top-4" style="border-left: 4px solid #e67e22 !important;">
                    <h6 class="mb-0 fw-semibold text-dark"><i class="bi bi-list-task me-2 text-primary"></i>My Action Items</h6>
                </div>
                <div class="card-body">
                    {% for task in assigned_tasks %}
                    {% if task.status != 'Completed' %}
                    <div class="p-3 border rounded-4 bg-light mb-3 last-mb-0">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="extra-small fw-bold text-primary">{{ task.master_task.task_no }}</span>
                            <span class="text-{% if task.status == 'WIP' %}info{% else %}secondary{% endif %} fw-bold extra-small">{{ task.status }}</span>
                        </div>
                        <div class="fw-bold text-dark small mb-2">{{ task.master_task.description }}</div>
                        <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top border-white">
                            <span class="extra-small text-muted">
                                {% if task.followup_date %}
                                <i class="bi bi-clock me-1"></i>{{ task.followup_date.strftime('%d %b') }}
                                {% else %}
                                <i class="bi bi-calendar-event me-1"></i>No Follow-up
                                {% endif %}
                            </span>
                            <button type="button" class="btn btn-sm btn-primary rounded-pill px-3 extra-small fw-bold" onclick="window.location.href='{{ url_for('main.view_task_details', task_id=task.id) }}'">Update</button>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Holidays Widget -->
            <div class="card border-0 shadow-sm rounded-4" style="border: 1px solid #e2e8f0 !important;">
                <div class="card-header bg-white py-3 border-0 rounded-top-4" style="border-left: 4px solid #e67e22 !important;">
                    <h6 class="mb-0 fw-semibold text-dark"><i class="bi bi-calendar-event me-2 text-primary"></i>Company Holidays</h6>
                </div>
                <div class="card-body pt-2">
                    <ul class="list-unstyled mb-0">
                        {% for holiday in holidays %}
                        <li class="py-2 d-flex justify-content-between align-items-center border-bottom border-light last-border-0">
                            <span class="small fw-medium text-dark">{{ holiday.name }}</span>
                            <span class="text-muted extra-small fw-bold">{{ holiday.date.strftime('%d %b') }}</span>
                        </li>
                        {% else %}
                        <li class="text-center text-muted extra-small py-2">No upcoming holidays.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-light border-0 shadow-sm text-center rounded-4">
        <h4 class="alert-heading text-dark fw-bold">Admin Portal</h4>
        <p class="text-muted small mb-0">You are currently logged in as a system administrator.</p>
    </div>
    {% endif %}
</div>

<style>
    .extra-small { font-size: 0.7rem; }
    .last-border-0:last-child { border-bottom: 0 !important; }
    .last-mb-0:last-child { margin-bottom: 0 !important; }
    .rounded-top-4 { border-top-left-radius: 12px !important; border-top-right-radius: 12px !important; }
    /* Ensure greeting and specific headers use elegant orange instead of white */
    .elegant-orange-text { color: #e67e22 !important; }
</style>

<script>
const searchInput = document.getElementById('directorySearch');

if (searchInput) {
    searchInput.addEventListener('input', function() {
        let query = this.value;
        if (query.length < 2) return;
        
        fetch(`{{ url_for('main.search_colleagues_api') }}?q=${query}`)
            .then(response => response.json())
            .then(data => {
                let dataList = document.getElementById('directory-suggestions');
                dataList.innerHTML = '';
                data.forEach(item => {
                    let option = document.createElement('option');
                    option.value = item.name;
                    dataList.appendChild(option);
                });
            })
            .catch(err => console.error(err));
    });
}

// Task Status Toggle Logic
document.querySelectorAll('.task-status-select').forEach(select => {
    select.addEventListener('change', function() {
        const taskId = this.dataset.taskId;
        const followupGroup = document.getElementById(`followup-group-${taskId}`);
        if (this.value === 'Completed' || this.value === 'Rejected') {
            followupGroup.style.display = 'none';
        } else {
            followupGroup.style.display = 'block';
        }
    });
});
</script>
{% endblock %}